<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVY Home - Hóa Đơn Tiền Phòng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7fa; color: #1e293b; display: flex; justify-content: center; padding: 40px 20px; min-height: 100vh; }
        
        /* Cố định kích thước bill để ảnh xuất ra luôn đẹp và nét */
        .bill-wrapper {
            width: 480px;
            background: white;
            border-radius: 36px;
            padding: 40px;
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.1);
            position: relative;
            flex-shrink: 0;
        }

        /* Nút nổi bên phải */
        .floating-btn {
            width: 120px;
            height: 120px;
            border-radius: 28px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 800;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .floating-btn:active { transform: scale(0.95); }
        .btn-blue { background: #4f46e5; background: linear-gradient(135deg, #4f46e5, #3b82f6); color: white; }
        .btn-cyan { background: #0891b2; background: linear-gradient(135deg, #0891b2, #06b6d4); color: white; }
        .btn-white { background: white; color: #64748b; }

        /* Modal / Toast */
        #toast {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 14px 28px; border-radius: 100px;
            font-weight: 700; font-size: 14px; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 50;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: flex; align-items: center; gap: 8px;
        }

        @media (max-width: 768px) {
            body { padding: 20px 10px; flex-direction: column; align-items: center; }
            .bill-wrapper { width: 100%; max-width: 480px; padding: 30px 20px; border-radius: 28px; }
            .action-panel { flex-direction: row; width: 100%; max-width: 480px; margin-top: 20px; justify-content: space-between; }
            .floating-btn { height: 80px; flex: 1; border-radius: 20px; }
            .floating-btn svg { width: 20px; height: 20px; margin-bottom: 4px; }
        }
    </style>
</head>
<body>

    <div id="toast"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg> <span id="toast-msg">Đã copy thành công!</span></div>

    <div class="flex flex-col md:flex-row gap-6 items-start justify-center max-w-5xl w-full">
        
        <!-- ================= HÓA ĐƠN CHÍNH ================= -->
        <div id="capture-area" class="bill-wrapper">
            <!-- Header Bill -->
            <div class="flex justify-between items-start mb-8">
                <div>
                    <h1 class="text-[32px] font-black text-slate-900 tracking-tighter leading-none" id="v_brand">SVY Home</h1>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wide mt-1" id="v_addr">ĐANG TẢI DỮ LIỆU...</p>
                </div>
                <div class="text-right">
                    <h2 class="text-[32px] font-black text-blue-600 tracking-tighter leading-none" id="v_title">HÓA ĐƠN</h2>
                    <p class="text-[11px] font-bold text-blue-600 uppercase tracking-wide mt-1" id="v_subtitle">CHI TIẾT TIỀN PHÒNG</p>
                </div>
            </div>

            <!-- Info Grid -->
            <div class="grid grid-cols-3 gap-4 mb-10">
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5" id="lbl_month">THÁNG</p>
                    <p class="text-xl font-black text-slate-800" id="v_month">-</p>
                </div>
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5" id="lbl_room">PHÒNG</p>
                    <p class="text-xl font-black text-slate-800" id="v_room">-</p>
                </div>
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5" id="lbl_tenant">KHÁCH THUÊ</p>
                    <p class="text-base font-black text-slate-800 leading-tight" id="v_tenant">-</p>
                </div>
            </div>

            <!-- Table -->
            <table class="w-full mb-8">
                <thead>
                    <tr class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                        <th class="text-left pb-4 w-12" id="lbl_stt">STT</th>
                        <th class="text-left pb-4" id="lbl_desc">MÔ TẢ</th>
                        <th class="text-right pb-4" id="lbl_amt">THÀNH TIỀN</th>
                    </tr>
                </thead>
                <tbody class="text-slate-800 font-semibold text-[15px]">
                    <tr class="border-t border-slate-100">
                        <td class="py-3.5 text-slate-400 font-bold">1</td>
                        <td class="py-3.5" id="lbl_rent">Tiền thuê nhà</td>
                        <td class="py-3.5 text-right font-black" id="v_rent_amt">0</td>
                    </tr>
                    <tr class="border-t border-slate-100">
                        <td class="py-3.5 text-slate-400 font-bold">2</td>
                        <td class="py-3.5" id="lbl_elec">Tiền điện</td>
                        <td class="py-3.5 text-right font-black" id="v_elec_amt">0</td>
                    </tr>
                    <tr class="border-t border-slate-100">
                        <td class="py-3.5 text-slate-400 font-bold">3</td>
                        <td class="py-3.5" id="lbl_water">Tiền nước</td>
                        <td class="py-3.5 text-right font-black" id="v_water_amt">0</td>
                    </tr>
                    <tr class="border-t border-slate-100">
                        <td class="py-3.5 text-slate-400 font-bold">4</td>
                        <td class="py-3.5" id="lbl_wifi">Tiền wifi</td>
                        <td class="py-3.5 text-right font-black" id="v_wifi_amt">0</td>
                    </tr>
                    <tr class="border-t border-slate-100">
                        <td class="py-3.5 text-slate-400 font-bold">5</td>
                        <td class="py-3.5" id="lbl_serv">Phí dịch vụ</td>
                        <td class="py-3.5 text-right font-black" id="v_serv_amt">0</td>
                    </tr>
                    <tr class="border-t border-b border-slate-100">
                        <td class="py-3.5 text-slate-400 font-bold">6</td>
                        <td class="py-3.5" id="lbl_other">Mục khác</td>
                        <td class="py-3.5 text-right font-black" id="v_other_amt">0</td>
                    </tr>
                    <tr>
                        <td colspan="2" class="py-6 text-blue-700 font-black text-lg tracking-tight" id="lbl_total">TỔNG CỘNG</td>
                        <td class="py-6 text-right text-blue-700 font-black text-[26px] tracking-tighter" id="v_total">0</td>
                    </tr>
                </tbody>
            </table>

            <!-- Electricity Details -->
            <div class="bg-[#f8fafc] border border-slate-100 rounded-2xl p-4 flex justify-between text-center items-center mb-10">
                <div>
                    <p class="text-[9px] font-bold text-slate-400 uppercase mb-1" id="lbl_e_old">ĐIỆN CŨ</p>
                    <p class="text-sm font-black text-slate-700" id="v_e_old">0</p>
                </div>
                <div>
                    <p class="text-[9px] font-bold text-slate-400 uppercase mb-1" id="lbl_e_new">ĐIỆN MỚI</p>
                    <p class="text-sm font-black text-slate-700" id="v_e_new">0</p>
                </div>
                <div>
                    <p class="text-[9px] font-bold text-slate-400 uppercase mb-1" id="lbl_e_used">SỬ DỤNG</p>
                    <p class="text-sm font-black text-blue-600" id="v_e_used">0</p>
                </div>
                <div class="border-l border-slate-200 pl-4 text-right">
                    <p class="text-[9px] font-bold text-slate-400 uppercase mb-1" id="lbl_e_sub">THÀNH TIỀN</p>
                    <p class="text-sm font-black text-blue-600" id="v_e_subtotal">0</p>
                </div>
            </div>

            <!-- Footer: Bank + QR -->
            <div class="flex gap-5">
                <div class="flex-1 bg-[#f4f7fb] rounded-2xl p-5 border border-slate-100">
                    <p class="text-[10px] font-bold text-blue-800 uppercase mb-2 tracking-wide" id="lbl_pay">THÔNG TIN CHUYỂN KHOẢN</p>
                    <p class="text-sm font-bold text-slate-700" id="v_bank">-</p>
                    <p class="text-[22px] font-black text-blue-700 tracking-tighter mt-1 mb-1" id="v_acc">-</p>
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest" id="v_owner">-</p>
                    
                    <div class="mt-4 pt-4 border-t border-slate-200/60">
                        <p class="text-[9px] font-bold text-slate-500 uppercase mb-1" id="lbl_code">NỘI DUNG CK:</p>
                        <p class="text-lg font-black text-slate-900 tracking-widest" id="v_code">-</p>
                        <p class="text-[9px] text-red-500 font-bold italic mt-1.5" id="lbl_note">* Vui lòng ghi chính xác nội dung ck</p>
                    </div>
                </div>
                
                <div class="flex flex-col items-center justify-end">
                    <div class="bg-white p-2 border border-slate-100 rounded-[20px] shadow-sm">
                        <img id="v_qr" src="" crossorigin="anonymous" class="w-[120px] h-[120px] object-contain rounded-xl">
                    </div>
                    <p class="text-[8px] font-bold text-slate-400 tracking-widest uppercase mt-2">VIETQR • NAPAS247</p>
                </div>
            </div>
        </div>

        <!-- ================= NÚT ACTION NỔI (BÊN PHẢI) ================= -->
        <div class="action-panel flex flex-col gap-4 gap-y-4">
            <button onclick="captureAndCopy()" class="floating-btn btn-blue">
                <svg class="mb-2" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                COPY <span class="hidden md:inline">&<br>GỬI</span> BILL
            </button>
            <button onclick="openApp()" class="floating-btn btn-cyan">
                <svg class="mb-2" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                MỞ NHÓM<br>ZALO
            </button>
            <button onclick="window.print()" class="floating-btn btn-white hidden md:flex">
                <svg class="mb-2" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline stroke-linecap="round" stroke-linejoin="round" points="6 9 6 2 18 2 18 9"/><path stroke-linecap="round" stroke-linejoin="round" d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14" stroke-linecap="round" stroke-linejoin="round"/></svg>
                IN BILL
            </button>
        </div>

    </div>

    <!-- Modal Fallback cho trình duyệt chặn Copy -->
    <div id="fallback-modal" class="fixed inset-0 bg-black/80 hidden z-50 justify-center items-center p-4">
        <div class="bg-white rounded-3xl p-6 max-w-md w-full text-center relative">
            <h3 class="text-xl font-black text-slate-800 mb-2">Gửi hóa đơn thủ công</h3>
            <p class="text-xs text-slate-500 font-medium mb-6">Trình duyệt không hỗ trợ copy tự động</p>
            
            <textarea id="fallback-text" readonly class="w-full h-20 p-3 bg-slate-50 border rounded-xl text-xs font-medium text-slate-700 mb-4 outline-none resize-none"></textarea>
            
            <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Nhấn giữ (hoặc click chuột phải) vào ảnh để Copy</p>
            <div id="fallback-img" class="border-2 border-slate-100 rounded-2xl overflow-hidden mb-6 flex justify-center bg-slate-50 p-2"></div>
            
            <button onclick="document.getElementById('fallback-modal').style.display='none'" class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-xl">ĐÓNG</button>
        </div>
    </div>

    <script>
        // Cấu hình các cơ sở
        const cfg = {
            "38HD": { name: "SVY Home", addr: "38 HOÀNG DIỆU, ĐÀ NẴNG", bank: "VIB", acc: "426704060074888", owner: "TRAN THI YEN PHUONG", isEn: false },
            "46HD": { name: "SVY Home", addr: "46 HOÀNG DIỆU, ĐÀ NẴNG", bank: "VIB", acc: "426704060074888", owner: "TRAN THI YEN PHUONG", isEn: false },
            "128TL": { name: "SVY Home", addr: "128 THĂNG LONG, ĐÀ NẴNG", bank: "VIB", acc: "426704060074888", owner: "TRAN THI YEN PHUONG", isEn: false },
            "07KMD10": { name: "SVY Apartment", addr: "07 KHUÊ MỸ ĐÔNG 10, ĐÀ NẴNG", bank: "VCB", acc: "1012345678", owner: "YOUR ACCOUNT NAME", isEn: true }
        };

        const t = {
            vi: {
                main: "HÓA ĐƠN", sub: "CHI TIẾT TIỀN PHÒNG", month: "THÁNG", room: "PHÒNG", tenant: "KHÁCH THUÊ",
                stt: "STT", desc: "MÔ TẢ", amt: "THÀNH TIỀN", rent: "Tiền thuê nhà", elec: "Tiền điện", water: "Tiền nước",
                wifi: "Tiền wifi", serv: "Phí dịch vụ", other: "Mục khác", total: "TỔNG CỘNG",
                eOld: "ĐIỆN CŨ", eNew: "ĐIỆN MỚI", eUsed: "SỬ DỤNG", eSub: "THÀNH TIỀN",
                pay: "THÔNG TIN CHUYỂN KHOẢN", code: "NỘI DUNG CK:", note: "* Vui lòng ghi chính xác nội dung ck"
            },
            en: {
                main: "INVOICE", sub: "RENTAL DETAILS", month: "MONTH", room: "ROOM", tenant: "TENANT",
                stt: "NO.", desc: "DESCRIPTION", amt: "AMOUNT", rent: "Room Rent", elec: "Electricity", water: "Water",
                wifi: "Wifi", serv: "Service Fee", other: "Others", total: "TOTAL",
                eOld: "OLD METER", eNew: "NEW METER", eUsed: "USED", eSub: "SUBTOTAL",
                pay: "BANK TRANSFER INFO", code: "TRANSFER REMARK:", note: "* Please enter exact remark"
            }
        };

        // Biến lưu trữ link nhóm Zalo
        let groupLink = "";
        let globalRoom = "";
        let globalMonth = "";
        let globalCode = "";
        let globalTotal = "0";

        function fmt(num) {
            return new Intl.NumberFormat('vi-VN').format(num || 0).replace(/,/g, '.');
        }

        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.style.background = isError ? '#ef4444' : '#1e293b';
            toast.style.top = '30px';
            setTimeout(() => { toast.style.top = '-100px'; }, 3000);
        }

        // Tự động load dữ liệu từ URL truyền vào
        function loadBillData() {
            const p = new URLSearchParams(window.location.search);
            
            const bld = p.get('building') || '38HD';
            const mon = p.get('month') || '-';
            const rom = p.get('room') || '-';
            const ten = p.get('tenant') || '-';
            groupLink = decodeURIComponent(p.get('link') || '');
            
            const eO = parseInt(p.get('e_old')) || 0;
            const eN = parseInt(p.get('e_new')) || 0;
            const eAmt = parseInt(p.get('e_amount')) || 0;
            const eU = Math.max(0, eN - eO);
            
            const rnt = parseInt(p.get('rent')) || 0;
            const wat = parseInt(p.get('water')) || 0;
            const wif = parseInt(p.get('wifi')) || 0;
            const srv = parseInt(p.get('s_fee')) || 0;
            const oth = parseInt(p.get('other')) || 0;
            
            const total = rnt + eAmt + wat + wif + srv + oth;
            
            const year = new Date().getFullYear();
            const code = `${bld}P${rom}T${mon}Y${year}`;

            // Lưu biến toàn cục để dùng khi nhắn tin
            globalRoom = rom;
            globalMonth = mon;
            globalCode = code;
            globalTotal = fmt(total);

            // Cấu hình ngôn ngữ & thông tin
            const c = cfg[bld] || cfg["38HD"];
            const lang = c.isEn ? t.en : t.vi;

            document.getElementById('v_brand').innerText = c.name;
            document.getElementById('v_addr').innerText = c.addr;
            document.getElementById('v_bank').innerText = c.bank + " Bank";
            document.getElementById('v_acc').innerText = c.acc;
            document.getElementById('v_owner').innerText = c.owner;
            document.getElementById('v_code').innerText = code;
            
            for(let k in lang) {
                const el = document.getElementById('lbl_' + k);
                if(el) el.innerText = lang[k];
            }
            document.getElementById('v_title').innerText = lang.main;
            document.getElementById('v_subtitle').innerText = lang.sub;

            // Đổ dữ liệu vào giao diện
            document.getElementById('v_month').innerText = `${mon} / ${year}`;
            document.getElementById('v_room').innerText = rom;
            document.getElementById('v_tenant').innerText = ten;

            document.getElementById('v_rent_amt').innerText = fmt(rnt);
            document.getElementById('v_elec_amt').innerText = fmt(eAmt);
            document.getElementById('v_water_amt').innerText = fmt(wat);
            document.getElementById('v_wifi_amt').innerText = fmt(wif);
            document.getElementById('v_serv_amt').innerText = fmt(srv);
            document.getElementById('v_other_amt').innerText = fmt(oth);
            document.getElementById('v_total').innerText = globalTotal;

            document.getElementById('v_e_old').innerText = fmt(eO);
            document.getElementById('v_e_new').innerText = fmt(eN);
            document.getElementById('v_e_used').innerText = fmt(eU);
            document.getElementById('v_e_subtotal').innerText = fmt(eAmt);

            // Tạo mã QR
            const qrUrl = `https://img.vietqr.io/image/${c.bank}-${c.acc}-qr_only.png?amount=${total}&addInfo=${encodeURIComponent(code)}&accountName=${encodeURIComponent(c.owner)}`;
            document.getElementById('v_qr').src = qrUrl;
        }

        // Mở App Zalo
        function openApp() {
            if(groupLink) {
                window.open(groupLink, '_blank');
            } else {
                showToast("Phòng này chưa có link Zalo!", true);
            }
        }

        // Chụp ảnh và Copy toàn bộ
        async function captureAndCopy() {
            showToast("Đang xử lý ảnh...");
            const node = document.getElementById('capture-area');
            const msg = `Chào bạn, SVY gửi hóa đơn phòng ${globalRoom} tháng ${globalMonth}.\nTổng tiền: ${globalTotal}đ\nNội dung CK: ${globalCode}`;
            
            try {
                const canvas = await html2canvas(node, { scale: 3, useCORS: true, backgroundColor: "#ffffff" });
                canvas.toBlob(async (blob) => {
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({ 
                                "image/png": blob, 
                                "text/plain": new Blob([msg], { type: "text/plain" }) 
                            })
                        ]);
                        showToast("✨ Đã copy Ảnh & Lời nhắn!");
                    } catch (e) {
                        // Fallback cho trình duyệt chặn
                        document.getElementById('fallback-text').value = msg;
                        document.getElementById('fallback-img').innerHTML = `<img src="${canvas.toDataURL()}" class="max-w-[200px] h-auto rounded-xl shadow-sm mx-auto block">`;
                        document.getElementById('fallback-modal').style.display = 'flex';
                    }
                }, 'image/png');
            } catch (err) {
                showToast("❌ Lỗi tạo ảnh", true);
            }
        }

        // Chạy ngay khi mở web
        window.onload = loadBillData;
    </script>
</body>
</html>
